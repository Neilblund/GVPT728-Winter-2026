---
title: "Class 11: Instrumental variables"
format:
  html:
    theme: [default, custom_styles]
    df-print: paged
    toc: true
    toc-location: left
    toc-depth: 3
    embed-resources: true
    code-link: true
    code-tools: true
code-annotations: select
---

```{r setup, include=FALSE }
knitr::opts_chunk$set(echo = TRUE, message=FALSE, warning=FALSE)
```

We'll look at some replication data from [Henne, P. S., & Klocek, J. (2019). Taming the gods: How religious conflict shapes state repression. Journal of Conflict Resolution, 63(1), 112-138.](https://journals-sagepub-com.proxy-um.researchport.umd.edu/doi/full/10.1177/0022002717728104) ([dataverse](https://dataverse.harvard.edu/dataset.xhtml?persistentId=doi:10.7910/DVN/1ZPOPB))

The authors examine the role of religious conflict in religious oppression. While it seems fairly intuitive that conflict might drive states to repress, untangling the relationship is plagued by simultaneity bias: conflict shapes repression and repression drives conflict.

To address this, the authors use everyone's favorite instrument: rough terrain! If we think that rough terrain will drive repression only through its impact on conflict, then we can overcome this bias.

```{r}
library(tidyverse)
library(labelled)
library(ivreg)
library(modelsummary)


data<- dataverse::get_dataframe_by_name(
  filename = 'Taming the Gods Replication Data.dta',
  .f = haven::read_dta,
  dataset = '10.7910/DVN/1ZPOPB', 
  server = "dataverse.harvard.edu")|>
  mutate(ccode = factor(ccode),
         year = factor(year)
         )




data <- data |>
  drop_na(
    RAS4,
    loggdp,
    logpop ,
    Ethnic,
    democracy ,
    Int_maxyear ,
    LND_TOTL ,
    relconflict,
    pctforest ,
    lmtnest
  )|>
  mutate(LND_TOTL_100K = LND_TOTL /100000)


coefnames <- c(
  "relconflict" = "Religious Conflict",
  "RAS4" = "Religious Repression",
  "loggdp" = "Ln GDP",
  "logpop" = "Ln Population",
  "Ethnic" = "Ethnic Fractionalization",
  "democracy" = "Democracy score",
  "Int_maxyear" = "Conflict Intensity",
  "LND_TOTL_100K" = "Total Landmass (100,000 K.)",
  "pctforest" = "% Forest",
  "lmtnest" = "Ln mountainous terrain",
  "(Intercept)" = "Constant"
)




```


| RAS4        | Religious Repression     | DV              |
|-------------|--------------------------|-----------------|
| loggdp      | Log GDP                  | Control         |
| logpop      | Log Population           | Control         |
| Ethnic      | Ethnic Fractionalization | Control         |
| democracy   | Democracy score          | Control         |
| Int_maxyear | Conflict intensity       | Control         |
| LND_TOTL    | Total Land Mass          | Control         |
| relconflict | Religious Conflict       | Causal Variable |
| pctforest   | \% Forest                | Instrument 1    |
| lmtnest     | \% Mountainous terrain   | Instrument 2    |



## Visualizing the model

We can use the `ggdag` package to visualize the sort of relationship implied by the IV model we're setting up: where the instruments are correlated with the main causal variable but uncorrelated with the potential unmeasured confounders:

```{r}

library(ggdag)

model<-dagify(
  RAS4 ~ relconflict + confounding_variables,
  relconflict ~  pctforest + lmtnest + confounding_variables ,
  latent = "confounding_variables",
  exposure = "relconflict",
  
  outcome = "RAS4")|>
  tidy_dagitty()|>
  dag_label(c("relconflict" = "Religious Conflict",
              "RAS4" = "Religious Repression",
              "pctforest" = "% Forest",
              "lmtnest" = "Ln mountainous terrain",
              "confounding_variables" ="Confounding variables"
              ))




ggdag(model, use_labels="label", text=FALSE) +
  theme_dag() 

```


# Does the instrument correlate? 

Our first question is whether the instruments correlate with the causal variable.

```{r}

data|>
  select(relconflict, pctforest, lmtnest)|>
  cor()









```

They do, albeit fairly weakly. The mountainous terrain variable does a much better job here.



# Regressions

We can start by using an OLS model that just includes all of the predictors but without the instruments.

```{r}
ols_model <- lm(RAS4 ~ loggdp + logpop + 
                  Ethnic + democracy + Int_maxyear +
                  LND_TOTL_100K  +  relconflict , data=data)



```


Next, we'll use the IVReg package to estimate our instrumental variable model. 

The formula here has three parts, separated by `|` symbols. 

The first part are the exogenous predictors (all those controls), the second is the endogenous predictor (religious conflict), and the last should be the instruments used to predict the endogenous predictor (rough terrain)

```{r}



iv_model <- ivreg(RAS4 ~ loggdp + logpop + Ethnic + democracy + 
                  Int_maxyear +LND_TOTL_100K
              | relconflict 
              | pctforest + lmtnest ,
              data=data
              )



```


The summary output from IV reg prints some useful tests we can use to assess the quality of the instrument here. 

- The "Weak instruments" tests for weak associations between the instrument and the endogenous predictor. Weak instruments can be biased in small samples, and in larger ones will result in inflated standard errors. The null here is a weak instrument, so we can reject that possibility.

- The Wu-Hausman test looks for evidence of endogeneity. If there is no endogeneity bias in the stage 2 regression, then there's probably no reason to use the instrument. The null hypothesis is "we'd be better off using OLS"

- The Sargan test looks for endogeneity in models with more instruments than endogenous predictors. The null hypothesis here is "the instruments are valid". The results here suggest an issue, although it would take a bit more digging to determine the nature of the problem. One possibility is that one of the two instruments is extraneous, or it fails to satisfy the exclusion restriction, or the two instruments have different effects on the endogenous predictors. 


```{r}

summary(iv_model)

```

Assuming we've moved beyond this concern, we can get our results and compare models. Here I'm getting bootstrapped standard errors with clustering on year and country: 


```{r}



mlist<-list("ols" = ols_model, "Instrumental Variables" = iv_model)

modelsummary(
  mlist,
  coef_map = coefnames,
  cov = "bootstrap",
  R = 1000,
  gof_map = c('nobs', 'aic', 'bic'),
  estimate  = "{estimate}",
  statistic = c("conf.int"),
  conf_level = .95,
  note = "95% CI in brackets",
  cluster = ~ ccode + year
)
            
```




### Further checks

We would undoubtedly want to do lots of additional checks here. One thing we might try is to see whether an alternative measure of our instrument still gives the expected results. The [peacesciencer](https://svmiller.com/peacesciencer/) has a bunch of utility functions for working with conflict data like this. It has supplies data from a [2012 paper](https://www-jstor-org.proxy-um.researchport.umd.edu/stable/41349158?seq=1) where the authors used a measure of elevation changes to measure rugged terrain. We'll see if the results are similar when using this variable as an instrument:

```{r}

library(peacesciencer)

rugged_data<-create_stateyears()|>
  add_rugged_terrain()|>
  mutate(ccode = paste(ccode), 
         year = paste(year)
         )|>
  right_join(data|>mutate(ccode = paste(ccode), year=paste(year)))




iv_model <- ivreg(RAS4 ~ loggdp + logpop + Ethnic + democracy + Int_maxyear +LND_TOTL_100K
              | relconflict 
              |  rugged,
              data=rugged_data
              )
              



summary(iv_model)





```


